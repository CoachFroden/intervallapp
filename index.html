<!DOCTYPE html>
<html lang="no">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intervalltimer</title>

<style>
body {
    font-family: system-ui, sans-serif;
    text-align: center;
    margin: 0;
    padding: 20px;
}

#display {
    font-size: 72px;
    margin: 20px 0;
}

button {
    font-size: 18px;
    padding: 10px 20px;
}
</style>
</head>

<body>

<h1>Intervalltimer</h1>

<div id="display">0</div>
<div id="sub"></div>

<button onclick="startSequence()">Start</button>
<button onclick="togglePause()">Pause</button>

<!-- LYDER -->
<audio id="beep1" src="beep.wav"></audio>
<audio id="beep2" src="beep.wav"></audio>
<audio id="finalBeep" src="langbeep.wav"></audio>

<audio id="readySound" src="gjordereklare.mp3"></audio>
<audio id="pauseWarningSound" src="pauseneroveromti.mp3"></audio>
<audio id="roundEndSound" src="endbuzzer.wav"></audio>

<script>
/* ---------- GLOBAL STATE ---------- */

let timer = null;
let startCountdownTimer = null;

let paused = false;

let mode = "work"; // work | rest | roundPause
let timeLeft = 0;

let work = 30;
let rest = 15;
let roundPause = 60;

let stations = 4;
let rounds = 3;

let currentStation = 1;
let currentRound = 1;

let beepToggle = false;

/* ---------- HJELPEFUNKSJONER ---------- */

function updateDisplay() {
    document.getElementById("display").innerText = timeLeft;
    document.getElementById("sub").innerText =
        `Runde ${currentRound}/${rounds} â€“ Stasjon ${currentStation}/${stations} (${mode})`;
}

function playBeep() {
    const beep = beepToggle
        ? document.getElementById("beep1")
        : document.getElementById("beep2");

    beep.currentTime = 0;
    beep.play();
    beepToggle = !beepToggle;
}

/* ---------- STARTSEKVENS ---------- */

function startSequence() {
    stopAllTimers();
    paused = false;

    // ðŸ”“ UNLOCK alle WAV-lyder (iOS)
    const unlock = id => {
        const a = document.getElementById(id);
        a.volume = 0;
        a.play().then(() => {
            a.pause();
            a.currentTime = 0;
            a.volume = 1;
        }).catch(() => {});
    };

    unlock("beep1");
    unlock("beep2");
    unlock("finalBeep");
    unlock("pauseWarningSound");

    runStartCountdown();
}

function runStartCountdown() {
    let count = 15;
    let readyPlayed = false;

    const readySound = document.getElementById("readySound");

    startCountdownTimer = setInterval(() => {
        count--;
        document.getElementById("display").innerText = count;

        if (count === 13 && !readyPlayed) {
            readySound.play();
            readyPlayed = true;
        }

        if ([5,4,3,2].includes(count)) playBeep();
        if (count === 1) document.getElementById("finalBeep").play();

        if (count <= 0) {
            clearInterval(startCountdownTimer);
            startCountdownTimer = null;
            startTimer();
        }
    }, 1000);
}

/* ---------- HOVEDTIMER ---------- */

function startTimer() {
    clearInterval(timer);

    mode = "work";
    currentStation = 1;
    currentRound = 1;
    timeLeft = work;

    updateDisplay();
    timer = setInterval(tick, 1000);
}

function tick() {
    if (paused) return;
    if (timeLeft <= 0) return;

    timeLeft--;
    updateDisplay();

    // ðŸ”” Rundepause-varsel
    if (mode === "roundPause" && timeLeft === 12) {
        document.getElementById("pauseWarningSound").play();
    }

    // ðŸ”Š Nedtelling
    if ([5,4,3,2].includes(timeLeft)) playBeep();
    if (timeLeft === 1) document.getElementById("finalBeep").play();

    if (timeLeft > 0) return;

    /* ----- OVERGANGER ----- */

    if (mode === "work") {
        if (currentStation === stations) {
            currentRound++;
            if (currentRound > rounds) return finish();

            mode = "roundPause";
            timeLeft = roundPause;
            currentStation = 1;
        } else {
            mode = "rest";
            timeLeft = rest;
        }
    }
    else if (mode === "rest") {
        currentStation++;
        mode = "work";
        timeLeft = work;
    }
    else if (mode === "roundPause") {
        mode = "work";
        timeLeft = work;
    }

    updateDisplay();
}

/* ---------- KONTROLLER ---------- */

function togglePause() {
    paused = !paused;

    if (!paused) {
        clearInterval(timer);
        timer = setInterval(tick, 1000);
    }
}

function stopAllTimers() {
    clearInterval(timer);
    clearInterval(startCountdownTimer);
    timer = null;
    startCountdownTimer = null;
}

function finish() {
    clearInterval(timer);
    document.getElementById("roundEndSound").play();
    document.getElementById("display").innerText = "FERDIG";
}
</script>

<!-- SERVICE WORKER AV UNDER UTVIKLING -->
<!--
<script>
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>
-->

</body>
</html>
